<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Storage Engine API: Storage Engine API</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
<link href="mongodb.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr>
  <td id="projectlogo"><img alt="Logo" src="mongodb-logo.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Storage Engine API
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Storage Engine API </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>See <a href="https://mongodbsource.github.io">https://mongodbsource.github.io</a> for the generated storage engine API documentation.</p>
<p>The purpose of the Storage Engine API is to allow for pluggable storage engines in MongoDB (refer to the <a href="http://docs.mongodb.org/manual/faq/storage">Storage FAQ</a>). This document gives a brief overview of the API, and provides pointers to places with more detailed documentation. Where referencing code, links are to the version that was current at the time when the reference was made. Always compare with the latest version for changes not yet reflected here. For questions on the API that are not addressed by this material, use the <a href="https://groups.google.com/forum/#!forum/mongodb-dev">mongodb-dev</a> Google group. Everybody involved in the Storage Engine API will read your post.</p>
<p>Third-party storage engines are integrated through self-contained modules that can be dropped into an existing MongoDB source tree, and will be automatically configured and included. A typical module would at least have the following files: </p><pre class="fragment">src/             Directory with the actual source files
README.md        Information specific to the storage engine
SConscript       Scons build rules
build.py         Module configuration script
</pre><p>See <a href="https://github.com/mongodb-partners/mongo-rocks">https://github.com/mongodb-partners/mongo-rocks</a> for a good example of the structure.</p>
<h2>Concepts </h2>
<h3>Record Stores</h3>
<p>See <a class="el" href="classmongo_1_1RecordStore.html">RecordStore</a></p>
<p>A database contains one or more collections, each with a number of indexes, and a catalog listing them. All MongoDB collections are implemented with record stores: one for the documents themselves, and one for each index. By using the <a class="el" href="classmongo_1_1KVEngine.html">KVEngine</a> class, you only have to deal with the abstraction, as the <a class="el" href="classmongo_1_1KVStorageEngine.html">KVStorageEngine</a> implements the StorageEngine interface, using record stores for catalogs and indexes.</p>
<h4>Record Identities</h4>
<p>A RecordId is a unique identifier, assigned by the storage engine, for a specific document or entry in a record store at a given time. For storage engines based in the <a class="el" href="classmongo_1_1KVEngine.html">KVEngine</a> the record identity is fixed, but other storage engines, such as MMAPv1, may change it when updating a document. Note that changing record ids can be very expensive, as indexes map to the RecordId. A single document with a large array may have thousands of index entries, resulting in very expensive updates.</p>
<h4>Cloning and bulk operations</h4>
<p>Currently all cloning, <a href="http://docs.mongodb.org/manual/core/replica-set-sync/#replica-set-initial-sync">initial sync</a> and other operations are done in terms of operating on individual documents, though there is a BulkBuilder class for more efficiently building indexes.</p>
<h3>Locking and Concurrency</h3>
<p>MongoDB uses multi-granular intent locking; see the <a href="http://docs.mongodb.org/manual/faq/concurrency/">Concurrency FAQ</a>. In all cases, this will ensure that operations to meta-data, such as creation and deletion of record stores, are serialized with respect to other accesses. Storage engines can choose to support document-level concurrency, in which case the storage engine is responsible for any additional synchronization necessary. For storage engines not supporting document-level concurrency, MongoDB will use shared/exclusive locks at the collection level, so all record store accesses will be serialized.</p>
<p>MongoDB uses <a href="http://en.wikipedia.org/wiki/Two-phase_locking">two-phase locking</a> (2PL) to guarantee serializability of accesses to resources it manages. For storage engines that support document level concurrency, MongoDB will only use intent locks for the most common operations, leaving synchronization at the record store layer up to the storage engine.</p>
<h3>Transactions</h3>
<p>Each operation creates an OperationContext with a new <a class="el" href="classmongo_1_1RecoveryUnit.html">RecoveryUnit</a>, implemented by the storage engine, that lives until the operation finishes. Currently, query operations that return a cursor to the client live as long as that client cursor, with the operation context switching between its own recovery unit and that of the client cursor. In a few other cases an internal command may use an extra recovery unit as well. The recovery unit must implement transaction semantics as described below.</p>
<h4>Atomicity</h4>
<p>Writes must only become visible when explicitly committed, and in that case all pending writes become visible atomically. Writes that are not committed before the unit of work ends must be rolled back. In addition to writes done directly through the Storage API, such as document updates and creation of record stores, other custom changes can be registered with the recovery unit.</p>
<h4>Consistency</h4>
<p>Storage engines must ensure that atomicity and isolation guarantees span all record stores, as otherwise the guarantee of atomic updates on a document and all its indexes would be violated.</p>
<h4>Isolation</h4>
<p>Storage engines must provide snapshot isolation, either through locking (as is the case for the MMAPv1 engine), through multi-version concurrency control (MVCC) or otherwise. The first read implicitly establishes the snapshot. Operations can always see all changes they make in the context of a recovery unit, but other operations cannot until a successful commit.</p>
<h4>Durability</h4>
<p>Once a transaction is committed, it is not necessarily durable: if, and only if the server fails, as result of power loss or otherwise, the database may recover to an earlier point in time. However, atomicity of transactions must remain preserved. Similarly, in a replica set, a primary that becomes unavailable may need to roll back to an earlier state when rejoining the replica set, if its changes were not yet seen by a majority of nodes. The RecoveryUnit implements methods to allow operations to wait for their committed transactions to become durable.</p>
<p>A transaction may become visible to other transactions as soon as it commits, and a storage engine may use a group commit, bundling a number of transactions to achieve durability. Alternatively, a storage engine may wait for durability at commit time.</p>
<h3>Write Conflicts</h3>
<p>Systems with optimistic concurrency control (OCC) or multi-version concurrency control (MVCC) may find that a transaction conflicts with other transactions, that executing an operation would result in deadlock or violate other resource constraints. In such cases the storage engine may throw a WriteConflictException to signal the transient failure. MongoDB will handle the exception, abort and restart the transaction.</p>
<h3>Point-in-time snapshot reads</h3>
<p>Two functions on the RecoveryUnit help storage engines implement point-in-time reads: setTimestamp() and selectSnapshot(). setTimestamp() is used by write transactions to label any forthcoming writes with a timestamp; these timestamps are then used to produce a point-in-time read transaction via a call to selectSnapshot() at the start of the read. The storage engine must produce the effect of reading from a snapshot that includes only writes with timestamps at or earlier than the selectSnapshot timestamp. This means that a point-in-time read may slice across prior write transactions by hiding only some data from a given write transaction, if that transaction had a different timestamp set prior to each write it did.</p>
<h2>Classes to implement </h2>
<p>A storage engine should generally implement the following classes. See their definitions for more details.</p>
<ul>
<li><a class="el" href="classmongo_1_1KVEngine.html">KVEngine</a></li>
<li><a class="el" href="classmongo_1_1RecordStore.html">RecordStore</a></li>
<li><a class="el" href="classmongo_1_1RecoveryUnit.html">RecoveryUnit</a></li>
<li><a class="el" href="classmongo_1_1SeekableRecordCursor.html">SeekableRecordCursor</a></li>
<li><a class="el" href="classmongo_1_1SortedDataInterface.html">SortedDataInterface</a></li>
<li>ServerStatusSection</li>
<li>ServerParameter </li>
</ul>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.15 </li>
  </ul>
</div>
</body>
</html>
